# Кореференция и всё, что с ней связано

## Исходные данные
Пока что — [корпус RuCor](http://rucoref.maimbava.net). Потом будут другие тексты.

## Добавляемая разметка
### Морфология
Добавляется при помощи [pymorphy2](http://pymorphy2.readthedocs.io/en/latest/index.html), который использует теги стандарта [OpenCorpora](http://opencorpora.org/dict.php?act=gram). Порядок действий следующий:

1. Текст токенизируется.
2. Каждый токен разбирается через ```pymorphy2.MorphAnalyzer```, потом добавляется к исходному разбору в виде ```(токен)\t(разбор)```.
3. Токены нумеруются: ```(номер)\t(токен)\t(разбор)```.
4. Результат записывается в новую папку.

## Конвертация в XML-формат, используемый в OpenCorpora
Подробнее — см. на [сайте OpenCorpora](http://opencorpora.org/), раздел "Скачать".

1. Текст разбивается на абзацы, исходя из предположения, что все абзацы разделяет двойная пустая строка (```\r\n\r\n```).
2. Первый абзац содержит *метаинформацию*, которая сначала достаётся в машиночитаемом формате через функцию ```get_meta```, а после этого из неё создаётся XML-код (функция ```head(text_params)```).
3. Счётчик слов ```word_count``` обнуляется. Абзацы со второго и дальше — это сам текст. Работа с ним организована следующим образом:
    
    3.1. Абзац разбивается на разборы: один разбор — одна строка.
    
    3.2. Из каждого разбора "достаётся" его offset и словоформа. Все параметры разделены табуляциями.
    
    3.3. До тех пор, пока ```offset текущего разбора + длина текущей словоформы + 1``` совпадает с ```offset следующего разбора```, мы считаем, что это одно предложение. Как только это условие нарушено, все накопленные разборы отправляются в функцию ```sentence_tokens```, которая оформляет все разборы в XML-формате OpenCorpora.
    
4. Работа с предложениями и словами. Разбор предложения в формате OpenCorpora выглядит так:
```xml
<source>%Это пример предложения.%</source>
<tokens>
    # про word_count написано выше, это счётчик слов в тексте
    <token text="%Это%" id=%word_count%>
        # rev_id — некоторое значение из внутреннего словаря OpenCorpora
        <tfr t="%Это%" rev_id="">
            <v>
                # id — некоторое значение из внутреннего словаря OpenCorpora
                <l t="%лемма%" id="">
                    <g v="%тег1%" />
                    <g v="%тег2%" />
                    <g v="%тег3%" />
                </l>
            </v>
        </tfr>
    </token>
</tokens>
```
(в примере в знаки процента заключены условные величины)
    
    